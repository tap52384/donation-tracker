<!-- client-size (browser) javascript common to all pages -->
<!-- use google.script.run to call server-side functions -->
<script>
/**
* . Returns true if the specified variable is null,
* . empty, or undefined.
* . @return boolean
*/
function isNullOrEmpty( x ) {
    return x === undefined || x === '' || x === null;
}

/**
* Returns true if the specified variable is null, empty, or with all spaces
* removed an empty string.
*/
function isNullOrEmptySpace( x ) {
  return isNullOrEmpty( x ) || typeof x.trim === 'function' &&
  isNullOrEmpty( x.trim().replace( / /g, '' ) );
}

function getValue( id ) {
  var element = document.getElementById( id );

  return element === null || isNullOrEmptySpace( element.value ) ? '' : element.value;
}

function disable( id, value ) {
  var element = document.getElementById( id );

  if ( element === null ) {
    return false;
  }

  element.disable = true;

  return true;
}

function enable( id ) {
  var element = document.getElementById( id );

  if ( element === null ) {
    return false;
  }

  element.disable = false;

  return true;
}

function showSpinner() {
  var element = document.getElementById( 'loading-spinner' );
  var button = document.querySelector( 'button[type="submit"]' );

  if ( element === null || button === null ) {
     return false;
  }

  // show the spinner
  element.style.display = 'inline';
  button.disabled = true;

  // also should disable the submit button
  disable( 'submit' );
  disable( 'delete' );
}

function hideSpinner() {
  var element = document.getElementById( 'loading-spinner' );
  var button = document.querySelector( 'button[type="submit"]' );

  if ( element === null || button === null ) {
     return false;
  }

  // show the spinner
  element.style.display = 'none';
  button.disabled = false;

  // also should enable the submit button
  enable( 'submit' );
}

/**
* . Returns true if the email address is possibly valid.
* . @param  string email
* . @return boolean
*/
function isValidEmail( email ) {
    var re = /\S+@\S+/;
    return re.test( email );
}

/**
 * Returns true if the object is a string.
 * @param  {[type]}  s [description]
 * @return {Boolean}   [description]
 */
function isValidStringObject( s ) {
    return !isNullOrEmpty( s ) &&
    Object.prototype.toString.call( s ) === '[object String]';
}

/**
 * Logs the specified text to the console if it is available.
 * @param  {[type]} text  [description]
 * @param  {[type]} error [description]
 * @return {[type]}       [description]
 */
function log( text, error ) {
    if ( isNullOrEmpty( text ) ) {
        return;
    }

    // 2015.03.04 - if the parameter is not a string, then break down what it is
    if ( isValidStringObject( text ) === false ) {
        text = JSON.stringify( text );
    }

    if ( window.console ) {

        if ( error && window.console.error ) {
          window.console.error( text );
        } else if ( window.console.log ) {
          window.console.log( text );
        }
    } else if ( document.console ) {

        if ( error && document.console.error ) {
          document.console.error( text );
        } else if ( document.console.log ) {
          document.console.log( text );
        }
    }
}

/**
* . Logs what happened when the app fails to retrieve a record.
* . @param  string result
* . @return void
*/
function getObjectFailed( result ) {
    log( 'getObjectFailed(); result: ' + JSON.stringify( result ) );
    log( 'getObjectFailed(); result: ' + result );

    // hide the spinner
    hideSpinner();
}

/**
  * . Once a user is selected, this fills in the fields with the user details.
  */
  function fillDetails( object ) {
    var isEmptyObject = true;

    // clear the fields first
    clearAllFields();

    // loops through the keys in the object and sets the values
    for ( var key in object ) {
      if ( isNullOrEmptySpace( key ) === true ) {
         log( 'fillDetails(); the key is null or empty space. skipping...' );
         continue;
      }

      // find the form element
      var element = document.getElementById( key.toLowerCase() );

      if ( element === null ) {
         log( 'fillDetails(); the element for key ' + key +
         ' could not be found. skipping...' );
         continue;
      }

      element.value = object[ key ];

      // marks the flag showing that this object is not empty
      isEmptyObject = false;
    }

    log( 'fillDetails(); data: ' + JSON.stringify( object ) );

    // enable the delete button
    document.getElementById( 'delete' ).disabled = ( isEmptyObject === true ? true : false );

    // hide the spinner
    hideSpinner();
  }

  /**
  * . Universal function for preparing data to be saved
  */
  function prepareSaveData2( fileName, selectId, headers ) {
    log( 'submit(' + fileName + '); headers: ' + headers );

    // get all of the data on the page using the headers
    var data = collect( headers );

    // add the id to the data
    var recordId = getValue( 'selectId' );
    data.ID = recordId;

    log( 'submit(' + fileName + '); data: ' + JSON.stringify( data ) );

    google.script.run.withSuccessHandler( saveResult )
    .withFailureHandler( hideSpinner )
    .saveData( fileName, recordId, data );
  }

  /**
  * . Using the headers of the spreadsheet managed by this page,
  * . get the values from all inputs with the same id.
  * . @return object
  */
  function collect( headers ) {
    var object = {};

    log( 'collect(); headers: ' + JSON.stringify( headers ) );

    for ( var key in headers ) {
      var header = headers[ key ];
      if ( isNullOrEmptySpace( key ) === true ||
      isNullOrEmptySpace( headers[ key ] ) === true ) {
        log( 'collect(); key is null or empty space' );
        continue;
      }

      // retrieves the value for the given input, trimming whitespace from
      // the ends
      var id = header.toLowerCase();
      object[ header ] = getValue( id ).trim();

      log( 'collect(); header: ' + header );
      log( 'collect(); value: ' + object[ header ] );
    }

    log( 'collect(); values: ' + JSON.stringify( object ) );

    return object;
  }

  /**
  * . Returns true if the given string represents a valid date.
  * . @param   string  dateString
  * . @returns boolean
  */
  function isValidDate( dateString ) {

     dateString = ( dateString + '' ).trim();
     if ( isNullOrEmptySpace( dateString ) === true ||
     dateString.match( /[0-9]{4}-[0-9]{2}-[0-9]{2}/ ) === null ) {
        return false;
     }

     var year = dateString.substr( 0, 4 );
     var month = dateString.substr( 5, 2 );
     var day = dateString.substr( 7 );
     var date = new Date( year, month, day );

     log( 'year:  ' + year );
     log( 'month: ' + month );
     log( 'day:   ' + day );
     log( 'date:  ' + date );

     // validate to make sure the date is valid
     // https://stackoverflow.com/a/1353711/1620794
     return isNaN( date ) === false;
  }

  /**
  * . Returns true if the specified input already exists in the menu.
  * . @param   array  inputArray An array of element IDs for the
  inputs that are used to create the text in the <select> element
  * . @param   string select The CSS selector for the <select> element
  * . @returns array Array of IDs the # of matching options in the
  <select> element, excluding the current one if it exists
  */
  function exists( inputArray, select ) {

    // 1. Using the IDs of the elements that specify the name of a unique record,
    // create the text
    var text = '';

    // array of matches
    var matches = [];

    // creates the text that is displayed in the <select> element using
    // the IDs of the elements specified in the inputArray
    for ( var key in inputArray ) {

       // gets the value of the input
       var input = getValue( inputArray[ key ] ).trim().toLowerCase();

       log( 'exists(); key: ' + key );
       log( 'exists(); value id: ' + inputArray[ key ] );
       log( 'exists(); value: ' + input );

       // skip if the input is empty
       if ( isNullOrEmptySpace( input ) === true ) {
         continue;
       }

       if ( isNullOrEmptySpace( text ) === false ) {
         text += ' ';
       }

       text += input;
    }

    log( 'exists(); form input: ' + text );

    // if this happens, then the validation prior to calling this function
    // did not catch everything. This should basically never happen
    if ( isNullOrEmptySpace( text ) === true ) {
       log( 'exists(); the text from the current form is empty. ' +
       'this should almost never happen.' );
       return matches;
    }

    // 2. Loop through each <option> in the <select> and see if the textcontent matches
    var menu = document.getElementById( select );

    if ( menu === null ) {
       window.console.error( 'exists(); could not find select' );
       return false;
    }

    var options = menu.options;

    if ( isNullOrEmptySpace( menu.options ) === true ||
    menu.options.length === 0 ) {
       log( 'exists(); no options in <select>' );
       return matches;
    }

    var menuIndex = menu.selectedIndex;

    // a string
    var selectedId = menu.options[ menuIndex ].value;
    var count = menu.options.length;

    log( 'exists(); selected index: ' + menuIndex );
    log( 'exists(); selected id: ' + selectedId );
    log( 'exists(); # of options: ' + count );


    // loop through each <option> within the <select> and get the text
    // compare the strings to see if they are equal
    for ( var i = 0; i < count; i++ ) {
       var option = menu.options[ i ];
       var optionText = ( option.text + '' ).trim().toLowerCase();
       var optionIndex = option.index;

       log( 'exists(); option text:  ' + optionText );
       log( 'exists(); option index: ' + option.index );
       log( 'exists(); text equal: ' + ( optionText === text ) );
       log( 'exists(); indexes equal: ' + ( menuIndex === option.index ) );

       // if the text is the same and the current option index equals
       // the index of the selected item (the one currently being edited / created )
       // then do not include it!
       if ( isNullOrEmptySpace( menuIndex ) === false &&
       parseInt( menuIndex, 10 ) === option.index &&
       optionText === text ) {
         log( 'exists(); editing existing record, no text change...' );
         continue;
       }

       if ( optionText !== text ) {
         continue;
       }

       // text matches
       log( 'exists(); current text match: ' + optionText );
       matches.push( option.index );
    }

    log( 'exists(); matched ids: ' + JSON.stringify( matches ) );

    // return an array containing any matches
    return matches;
  }

  // handles the close button
  document.getElementById( 'close' ).addEventListener( 'click', function( event ) {

     // closes the dialog window
     // https://developers.google.com/apps-script/guides/html/reference/host
     google.script.host.close();

  } );

  document.getElementById( 'reset' ).addEventListener( 'click', function( event ) {

    // disable the delete button
    var button = document.getElementById( 'delete' );
    if ( button !== null ) {
      button.disabled = true;
    }

    // set the focus to the input to the first <input>
    var inputs = document.getElementsByTagName('input');
    if ( inputs !== null && inputs.lengths > 0 ) {
        inputs[ 0 ].focus();
    }
  } );

</script>
