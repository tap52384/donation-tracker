/* eslint-env browser, node */
/* global moment */

;( function( code, $, window, document, google, moment, undefined ) {

// This allows for javascript that should work pretty consistently across browsers and platforms.
'use strict';

/**
* . Returns true if the specified variable is null,
* . empty, or undefined.
* . @return boolean
*/
code.isNullOrEmpty = function( x ) {
    return x === undefined || x === '' || x === null;
};

/**
* Returns true if the specified variable is null, empty, or with all spaces
* removed an empty string.
*/
code.isNullOrEmptySpace = function( x ) {
  return code.isNullOrEmpty( x ) || typeof x.trim === 'function' &&
  code.isNullOrEmpty( x.trim().replace( / /g, '' ) );
};

/**
* Changes a string to title case.
* @returns string
* @link https://gist.github.com/SonyaMoisset/b2606b3a7048cc5303f64a726a39e5fd#file-title-case-a-sentence-with-map-wc-js
*/
code.titleCase = function( str ) {
  return str.toLowerCase().split( ' ' ).map( function( word ) {
    return ( word.charAt( 0 ).toUpperCase() + word.slice( 1 ) );
  } ).join( ' ' );
};

/**
 * Retrieves the name of the function for logging purposes.
 * @param  {function|arguments} obj A function or its arguments.
 * @return {string}
 * @see {@link https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Functions/arguments|MDN}
 */
code.getFnName = function( obj ) {
    if ( code.isNullOrEmpty( obj ) === true ) {
        return '';
    }

    if ( obj && obj.callee && obj.callee.name ) {
        return obj.callee.name;
    }

    // Match:
    // - ^          the beginning of the string
    // - function   the word 'function'
    // - \s+        at least some white space
    // - ([\w\$]+)  capture one or more valid JavaScript identifier characters
    // - \s*        optionally followed by white space (in theory there won't
    //              be any here, so if performance is an issue this can be
    //              omitted[1]
    // - \(         followed by an opening brace
    //
    var result = /^function\s+([\w\$]+)\s*\(/.exec( obj.toString() );

    // for an anonymous function there
    // won't be a match
    return  result  ?  result[ 1 ]  :  '';
};

/**
 * Logs the specified text to the console if it is available.
 * @param  {[type]} text  [description]
 * @param  {[type]} error [description]
 * @return {[type]}       [description]
 */
code.log = function( text, error ) {
    if ( code.isNullOrEmpty( text ) ) {
        return;
    }

    // 2015.03.04 - if the parameter is not a string, then break down what it is
    if ( code.isValidStringObject( text ) === false ) {
        text = JSON.stringify( text );
    }

    // 2018.08.06 - add the function name to each log
    // so we can more easily track where errors
    // originated from
    // var name = code.getFnName( fn );
    // if ( code.isNullOrEmptySpace( name ) === false ) {
    //     text = name + '(): ' + text;
    // }


    if ( typeof window !== 'undefined' && window.console ) {

        if ( error && window.console.error ) {
          window.console.error( text );
        } else if ( window.console.log ) {
          window.console.log( text );
        }
    } else if ( typeof document !== 'undefined' && document.console ) {

        if ( error && document.console.error ) {
          document.console.error( text );
        } else if ( document.console.log ) {
          document.console.log( text );
        }
    } else if ( console ) {
        if ( error && console.error ) {
          console.error( text );
        } else if ( console.log ) {
          console.log( text );
        }
    }
};


code.getValue = function( id ) {
  var element = document.getElementById( id );

  return element === null || code.isNullOrEmptySpace( element.value ) ?
  '' :
  element.value;
};


code.disable = function( id ) {
  var element = document.getElementById( id );

  if ( element === null ) {
    return false;
  }

  element.disable = true;

  return true;
};

code.enable = function( id ) {
  var element = document.getElementById( id );

  if ( element === null ) {
    return false;
  }

  element.disable = false;

  return true;
};

/**
 * TODO: This button disables a button and shows the spinner.
 * Perhaps it only needs to manipulate the spinner...
 * @return {[type]} [description]
 */
code.showSpinner = function() {
  var element = document.getElementById( 'loading-spinner' );

  // var button = document.querySelector( 'button[type="submit"]' );

  if ( element === null ) {
     return false;
  }

  // show the spinner
  element.style.display = 'inline';

  // if a submit button exists, disable it
  // if ( button !== null ) {
  //     button.disabled = true;
  // }

  // also should disable the submit button
  // code.disable( 'submit' );
  // code.disable( 'delete' );
};

/**
 * [description]
 * @return {[type]} [description]
 */
code.hideSpinner = function() {
  var element = document.getElementById( 'loading-spinner' );

  // var button = document.querySelector( 'button[type="submit"]' );

  if ( element === null ) {
     return false;
  }

  // show the spinner
  element.style.display = 'none';

  // button.disabled = false;

  // also should enable the submit button
  // code.enable( 'submit' );
};

/**
 * This is an unused placeholder function called by the common javascript file
 * to reset all of the fields on a form.
 * @return {[type]} [description]
 */
code.clearAllFields = function() {

};

/**
* . Returns true if the email address is possibly valid.
* . @param  string email
* . @return boolean
*/
code.isValidEmail = function( email ) {
    var re = /\S+@\S+/;
    return re.test( email );
};

/**
 * Returns true if the object is a string.
 * @param  {[type]}  s [description]
 * @return {Boolean}   [description]
 */
code.isValidStringObject = function( s ) {
    return Object.prototype.toString.call( s ) === '[object String]';
};

/**
 * Returns true if the object is a number
 * @param  {object} input [description]
 * @return {boolean}       [description]
 */
code.isNumber = function( input ) {
    return typeof input === 'number' ||
    Object.prototype.toString.call( input ) === '[object Number]';
};

/**
 * Returns true if the object is a Date and has a valid date.
 * @param  {Date} d [description]
 * @return {boolean}   [description]
 */
code.isValidDateObject = function( d ) {
    return code.isNullOrEmptySpace( d ) === false &&
    Object.prototype.toString.call( d ) === '[object Date]' &&
    !isNaN( d.getTime() );
};


/**
* . Logs what happened when the app fails to retrieve a record.
* . @param  string result
* . @return void
*/
code.getObjectFailed = function( result ) {
    code.log( 'getObjectFailed(); result: ' + JSON.stringify( result ) );
    code.log( 'getObjectFailed(); result: ' + result );

    // hide the spinner
    code.hideSpinner();
};

/**
 * Returns true if the specified property exists in the specified object.
 * @param obj An object.
 * @param prop A property name, property has to be a string.
 * @return bool
 */
code.hasProperty = function( obj, prop ) {

    return code.isNullOrEmpty( obj ) === false &&
    code.isNullOrEmptySpace( prop ) === false &&
    (
        Object.prototype.hasOwnProperty.call( obj, prop ) ||
        obj.hasOwnProperty( prop ) ||
        obj.prop !== undefined ||
        'undefined' !== typeof obj[ prop ]
    );
};

/**
 * Returns true if the specified object has no properties.
 * @param obj An object.
 * @return bool
 */
code.isEmptyObject = function( obj ) {

    // empty objects have no properties
    if ( obj === null || obj === undefined ) {
        code.log( 'isEmptyObject(): object is null or undefined.' );
        return true;
    }

    // ECMAScript5 method of counting properties
    if ( Object && code.hasProperty( Object, 'getOwnPropertyNames' ) ) {
        var length = Object.getOwnPropertyNames( obj ).length;
        code.log( 'isEmptyObject(): getOwnPropertyNames revealed ' +
        length + ' properties in this object.' );
        return Object.getOwnPropertyNames( obj ).length === 0;
    }

    if ( obj.length > 0 ) {
        code.log( 'isEmptyObject(): object has a length property greater than 0' );
        return false;
    }

    for ( var key in obj ) {
        if ( hasOwnProperty.call( obj, key ) ) {
            code.log( 'isEmptyObject(): hasOwnProperty found at least one property.' );
            return false;
        }
    }

    // default value
    code.log( 'isEmptyObject(): failed to prove at least one property exists.' );
    return true;
};

/**
 * Prints all properties of the given object to the console.
 * @param  object obj
 * @return void
 */
code.printProperties = function( obj ) {

    // stop here if the object is empty
    if ( code.isEmptyObject( obj ) === true ) {
        code.log( 'The specified object does not have any properties.' );
        return;
    }

    code.log( 'specified object is not empty: ' + obj );

    Object.getOwnPropertyNames( obj ).forEach(
        function( val ) {

            // if an object, call this object recursively?
            var type = Object.prototype.toString.call( obj[ val ] );

            if ( type === '[object Object]' ||
            type.indexOf( '[object' ) !== -1 ) {
                code.log( val + ':' );
                code.printProperties( obj[ val ] );
            }

            code.log( val + ' -> ' + obj[ val ] );
        }
    );
};

/**
  * . Once a user is selected, this fills in the fields with the user details.
  */
code.fillDetails = function( object ) {
    var isEmptyObject = true;

    // clear the fields first
    code.clearAllFields();

    // loops through the keys in the object and sets the values
    for ( var key in object ) {
      if ( code.isNullOrEmptySpace( key ) === true ) {
         code.log( 'fillDetails(); the key is null or empty space. skipping...' );
         continue;
      }

      // find the form element
      var element = document.getElementById( key.toLowerCase() );

      if ( element === null ) {
         code.log( 'fillDetails(); the element for key ' + key +
         ' could not be found. skipping...' );
         continue;
      }

      element.value = object[ key ];

      // marks the flag showing that this object is not empty
      isEmptyObject = false;
    }

    code.log( 'fillDetails(); data: ' + JSON.stringify( object ) );

    // enable the delete button
    document.getElementById( 'delete' ).disabled = isEmptyObject === true;

    // hide the spinner
    code.hideSpinner();
  };

  /**
   * Fills the specified <select> element with data from
   * the specified filename.
   * @param  {string} filename    [description]
   * @param  {string} id          [description]
   * @param  {string} defaultText [description]
   * @return {void}
   */
  code.getMenu = function( filename, id, defaultText ) {

      // 1. Get the headers
      google.script.run.withSuccessHandler( code.fillMenu )
      .withFailureHandler( code.fillMenu )
      .getMenuData( filename, id, defaultText );

      // 2. Show the loading spinner
      code.showSpinner();
  };

  /**
   * 1. specify the filename to get headers and data
   * 2. specify the ID of the select element to be populated
   * 3. specify the default item text for the menu
   * 4. get the default sort array for each file type (server-side)
   * 5. Return an object where each piece is a property:
   * data, filename, headers, id, text
   * @param  {[type]} output [description]
   * @return {[type]}        [description]
   */
  code.fillMenu = function( output ) {

      // 1. Make sure the select element exists
      var select = document.getElementById( output.selectId );

      if ( select === null ) {
          code.log( 'fillMenu(); invalid id "' + output.selectId +
          '" specified for menu' );
          code.clearAllFields();
          code.hideSpinner();
          return false;
      }

      // 2. Set the default item at the top of the menu
      var html = '';

      if ( code.isNullOrEmptySpace( output.defaultText ) === false ) {
          html = '<option value="">' + output.defaultText + '</option>';
      }

      var count = code.isNullOrEmpty( output.data ) === false &&
      output.data.length ?
      output.data.length : 0;

      for ( var i = 0; i < count; i++ ) {
          html += '<option value="' + output.data[ i ][ 0 ] + '">';

          // TODO: this needs to display the proper text; the value
          // is fine
          html += code.getMenuItemText( output.data[ i ], output.sortArray );
          html += '</option>';
      }

      // 3. Set the HTML of the menu
      select.innerHTML = html;

      // 4. Clear any form fields and hide the loading spinner
      code.clearAllFields();
      code.hideSpinner();
      return true;
  };

  /**
   * Sets the display data for the menu items in the menu.
   * @param  {array} data      [description]
   * @param  {array} sortArray [description]
   * @return {string}           [description]
   */
  code.getMenuItemText = function( data, sortArray ) {

      var text = '';
      var count = sortArray.length;

      for ( var i = 0; i < count; i++ ) {
        var row = sortArray[ i ];

        code.log( 'getMenuItemText(); row: ' + JSON.stringify( row ) );
        if ( code.isNullOrEmptySpace( text ) === false ) {
            text += ' ';
        }
        text += data[ ( row.column - 1 ) ];
      }

      return code.titleCase( text );
  };

  /**
  * . Universal function for preparing data to be saved
  */
  code.prepareSaveData2 = function( fileName, selectId, headers ) {
    code.log( 'submit(' + fileName + '); headers: ' + headers );

    // get all of the data on the page using the headers
    var data = code.collect( headers );

    // add the id to the data
    var recordId = code.getValue( 'selectId' );
    data.ID = recordId;

    code.log( 'submit(' + fileName + '); data: ' + JSON.stringify( data ) );

    google.script.run.withSuccessHandler( code.saveResult )
    .withFailureHandler( code.hideSpinner )
    .saveData( fileName, recordId, data );
  };

  /**
  * . Using the headers of the spreadsheet managed by this page,
  * . get the values from all inputs with the same id.
  * . @return object
  */
  code.collect = function( headers ) {
    var object = {};

    code.log( 'collect(); headers: ' + JSON.stringify( headers ) );

    for ( var key in headers ) {
      var header = headers[ key ];
      if ( code.isNullOrEmptySpace( key ) === true ||
      code.isNullOrEmptySpace( headers[ key ] ) === true ) {
        code.log( 'collect(); key is null or empty space' );
        continue;
      }

      // retrieves the value for the given input, trimming whitespace from
      // the ends
      // 2018.08.19 - removes any dollar signs from any specified fields
      var id = header.toLowerCase();
      object[ header ] = code.getValue( id ).trim().replace( /\$/gi, '' );

      code.log( 'collect(); header: ' + header );
      code.log( 'collect(); value: ' + object[ header ] );
    }

    code.log( 'collect(); values: ' + JSON.stringify( object ) );

    return object;
  };

  /**
   * Given an array of headers in a given file, give the
   * numeric column index (0-based).
   * @param  {array} headers
   * @param  {string} name
   * @return {int}
   */
  code.getHeaderIndex = function( headers, name ) {

      if ( Array.isArray( headers ) === false ||
      code.isNullOrEmptySpace( name ) === true ) {
          return -1;
      }
      var count = headers.length;

      for ( var i = 0; i < count; i++ ) {
          if ( headers[ i ].toLowerCase() === name.toLowerCase() ) {
              return i;
          }
      }

      return -1;
  };


  /**
  * . Returns true if the given string represents a valid date.
  * . @param   string  dateString
  * . @returns boolean
  */
  code.isValidDate = function( dateString ) {

     dateString = ( dateString + '' ).trim();
     if ( code.isNullOrEmptySpace( dateString ) === true ||
     dateString.match( /[0-9]{4}-[0-9]{2}-[0-9]{2}/ ) === null ) {
        return false;
     }

     var year = dateString.substr( 0, 4 );
     var month = dateString.substr( 5, 2 );
     var day = dateString.substr( 7 );
     var date = new Date( year, month, day );

     code.log( 'year:  ' + year );
     code.log( 'month: ' + month );
     code.log( 'day:   ' + day );
     code.log( 'date:  ' + date );

     // validate to make sure the date is valid
     // https://stackoverflow.com/a/1353711/1620794
     return isNaN( date ) === false;
  };

  /**
  * . Returns true if the specified input already exists in the menu.
  * . @param   array  inputArray An array of element IDs for the
  inputs that are used to create the text in the <select> element
  * . @param   string select The CSS selector for the <select> element
  * . @returns array Array of IDs the # of matching options in the
  <select> element, excluding the current one if it exists
  */
  code.exists = function( inputArray, select ) {

    // 1. Using the IDs of the elements that specify the name of a unique record,
    // create the text
    var text = '';

    // array of matches
    var matches = [];

    // creates the text that is displayed in the <select> element using
    // the IDs of the elements specified in the inputArray
    for ( var key in inputArray ) {

       // gets the value of the input
       var input = code.getValue( inputArray[ key ] ).trim().toLowerCase();

       code.log( 'exists(); key: ' + key );
       code.log( 'exists(); value id: ' + inputArray[ key ] );
       code.log( 'exists(); value: ' + input );

       // skip if the input is empty
       if ( code.isNullOrEmptySpace( input ) === true ) {
         continue;
       }

       if ( code.isNullOrEmptySpace( text ) === false ) {
         text += ' ';
       }

       text += input;
    }

    code.log( 'exists(); form input: ' + text );

    // if this happens, then the validation prior to calling this function
    // did not catch everything. This should basically never happen
    if ( code.isNullOrEmptySpace( text ) === true ) {
       code.log( 'exists(); the text from the current form is empty. ' +
       'this should almost never happen.' );
       return matches;
    }

    // 2. Loop through each <option> in the <select> and see if the textcontent matches
    var menu = document.getElementById( select );

    if ( menu === null ) {
       code.log( 'exists(); could not find <select> element with ID "' + select +
       '"', true );
       return false;
    }

    var options = menu.options;

    if ( code.isNullOrEmptySpace( menu.options ) === true ||
    menu.options.length === 0 ) {
       code.log( 'exists(); no options in <select> element with ID "' + select + '"' );
       return matches;
    }

    var menuIndex = menu.selectedIndex;

    // a string
    var selectedId = menu.options[ menuIndex ].value;
    var count = menu.options.length;

    code.log( 'exists(); selected index: ' + menuIndex );
    code.log( 'exists(); selected id: ' + selectedId );
    code.log( 'exists(); # of options: ' + count );


    // loop through each <option> within the <select> and get the text
    // compare the strings to see if they are equal
    for ( var i = 0; i < count; i++ ) {
       var option = menu.options[ i ];
       var optionText = ( option.text + '' ).trim().toLowerCase();
       var optionIndex = option.index;

       code.log( 'exists(); option text:  ' + optionText );
       code.log( 'exists(); option index: ' + option.index );
       code.log( 'exists(); text equal: ' + ( optionText === text ) );
       code.log( 'exists(); indexes equal: ' + ( menuIndex === option.index ) );

       // if the text is the same and the current option index equals
       // the index of the selected item (the one currently being edited / created )
       // then do not include it!
       if ( code.isNullOrEmptySpace( menuIndex ) === false &&
       parseInt( menuIndex, 10 ) === option.index &&
       optionText === text ) {
         code.log( 'exists(); editing existing record, no text change...' );
         continue;
       }

       if ( optionText !== text ) {
         continue;
       }

       // text matches
       code.log( 'exists(); current text match: ' + optionText );
       matches.push( option.index );
    }

    code.log( 'exists(); matched ids: ' + JSON.stringify( matches ) );

    // return an array containing any matches
    return matches;
  };

  /**
   * Returns true if the object is numeric. Must be a string or number object.
   * @param  {string|int} obj
   * @return {boolean}
   */
  code.isNumeric = function( obj ) {

      // 1. Must be a number of a string
      return ( code.isNumber( obj ) === true ||
      code.isValidStringObject( obj ) === true ) &&

      // parseFloat NaNs numeric-cast false positives ("")
			// ...but misinterprets leading-number strings, particularly hex literals ("0x...")
			// subtraction forces infinities to NaN
			!isNaN( obj - parseFloat( obj ) );
  };

  /**
   * Returns an error any info for this donation is invalid, an empty string if
   * all input passes validation.
   * @param  {[type]} donationId      [description]
   * @param  {[type]} donorId         [description]
   * @param  {[type]} amount          [description]
   * @param  {[type]} paymentMethodId [description]
   * @param  {[type]} donationTypeId  [description]
   * @param  {string} givenAt         [description]
   * @return {string}                 [description]
   */
  code.validateDonationInput = function(
      donationId,
      donorId,
      amount,
      paymentMethodId,
      donationTypeId,
      givenAt
  ) {

      // 0. Fix the amount given
      amount = ( '' + amount ).replace( /\$/gi, '' ).trim();

      var error = '';

      // 1. The ID of the donation either must be empty or a positive number
      if ( code.isNullOrEmptySpace( donationId ) === false &&
      ( code.isNumeric( donationId ) === false ||
      parseInt( donationId, 10 ) < 0 ) ) {
          error = 'Invalid donation ID. Please report this error to be fixed.';
      }

      // 2. Every donation must have a valid donor ID
      else if ( code.isNumeric( donorId ) === false ||
      parseInt( donorId, 10 ) < 0 ) {
          error = 'Please select a donor.';
      }

      // 3. The amount must be a positive number greater than 0
      else if ( code.isNullOrEmptySpace( amount ) === true ||
      isNaN( amount ) === true || +amount !== +amount ||
      parseFloat( amount ) <= 0 ) {
         error = 'Please enter a donation amount greater than 0.';
      }

      // 4. Must have a valid payment method ID, even if they have been deleted
      else if ( code.isNullOrEmptySpace( paymentMethodId ) === true ||
      code.isNumeric( paymentMethodId ) === false ||
      parseInt( paymentMethodId, 10 ) < 0 ) {
          error = 'Please select a valid payment method.';
      }

      // 5. Must have a valid donation type, even if they have been deleted
      else if ( code.isNullOrEmptySpace( donationTypeId ) === true ||
      code.isNumeric( donationTypeId ) === false ||
      parseInt( donationTypeId, 10 ) < 0 ) {
          error = 'Please select a valid donation type.';
      } else if ( code.isValidDate( givenAt ) === false ) {
          error  = 'Please enter a valid donation date in the format YYYY-MM-DD.';
      }

      return error;
  };

  /**
   * Returns true if the element has the specified class.
   * @param  {HTMLDomElement} element   [description]
   * @param  {string} className [description]
   * @return {boolean}
   * @see https://stackoverflow.com/a/5898748/1620794
   */
  code.hasClass = function( element, className ) {
      return code.isNullOrEmpty( element ) === false &&
      element.className &&
      ( ' ' + element.className + ' ' ).indexOf( ' ' + className + ' ' ) > -1;
  };

  code.closeButton = document.getElementById( 'close' );
  code.resetButton = document.getElementById( 'reset' );

  // handles the close button
  if ( code.isNullOrEmpty( code.closeButton ) === false ) {
    code.closeButton.addEventListener( 'click', function() {

       // closes the dialog window
       // https://developers.google.com/apps-script/guides/html/reference/host
       google.script.host.close();

    } );
  }

  if ( code.isNullOrEmpty( code.resetButton ) === false ) {
    document.getElementById( 'reset' ).addEventListener( 'click', function() {

      // disable the delete button
      var button = document.getElementById( 'delete' );
      if ( button !== null ) {
        button.disabled = true;
      }

      // set the focus to the input to the first <input>
      var inputs = document.getElementsByTagName( 'input' );
      if ( inputs !== null && inputs.lengths > 0 ) {
          inputs[ 0 ].focus();
      }
    } );
  }

  /**
   * Returns only the date portion of the ISO-formatted date string.
   * @return {string} [description]
   */
  Date.prototype.toISODateString =
  Date.prototype.toISODateString || function() {
      var string = this.toISOString();
      var format = 'YYYY-MM-DD';
      return string.substring( 0, format.length );
  };

  /**
   * Returns true if the object is an array.
   * https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/isArray#Polyfill
   * @param  {object} value
   * @return {boolean}
   */
  Array.isArray = Array.isArray || function( value ) {
      return Object.prototype.toString.call( value ) === '[object Array]';
  };

  /**
   * https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/filter#Polyfill
   * @param  {function}  func
   * @param  {Boolean}   thisArg
   * @return {Array}
   */
  Array.prototype.filter = Array.prototype.filter = function( func, thisArg ) {
    'use strict';
    if ( !( ( typeof func === 'Function' || typeof func === 'function' ) && this ) ) {
throw new TypeError();
}

    var len = this.length >>> 0,
        res = new Array( len ), // preallocate array
        t = this, c = 0, i = -1;
    if ( thisArg === undefined ) {
      while ( ++i !== len ) {

        // checks to see if the key was set
        if ( i in this ) {
          if ( func( t[ i ], i, t ) ) {
            res[ c++ ] = t[ i ];
          }
        }
      }
    } else {
      while ( ++i !== len ) {

        // checks to see if the key was set
        if ( i in this ) {
          if ( func.call( thisArg, t[ i ], i, t ) ) {
            res[ c++ ] = t[ i ];
          }
        }
      }
    }

    res.length = c; // shrink down array to proper size
    return res;
  };

  // log that the file has been reached
  code.log( 'common.client.js loaded.' );


  // confirms whether the user is sure if they want to complete the given action
} )( window.code = window.code || {},
    window.jQuery,
    window,
    document,
    window.google,
    window.moment
);

// Down here is the code the defines the parameters used at the top of this
// self-executing function. undefined is not defined so it is undefined. LOL
