/* eslint-env browser, node */
/* global moment */

;( function( code, $, window, document, google, moment, undefined ) {

// This allows for javascript that should work pretty consistently across browsers and platforms.
'use strict';

// log that the file has been reached
code.log( 'edit.client.js loaded.' );

code.donors = document.getElementById( 'donor_id' );
code.endAt = document.getElementById( 'end_at' );
code.startAt = document.getElementById( 'start_at' );
code.loadBtn = document.getElementById( 'edit-donations-load-btn' );
code.donationsTable = document.getElementById( 'edit-donations-table' );

/**
 * Adds the options to the "donors" select element.
 * @param  {[type]} output [description]
 * @return {[type]}        [description]
 */
code.addDonorsHtml = function( output ) {

    code.log( 'addDonorsHtml(); output: ' + JSON.stringify( output ) );

    if ( code.isNullOrEmpty( output ) === true ) {

        // stop the spinner
        code.hideSpinner();

        return false;
    }

    // add an option for manually entering the name of a new donor on the fly
    // output = '<option value="-1">Add new donor</option>' + output;
    var donorMenu = document.getElementById( output.selectId );

    // set the HTML of the select element
    var html = '<option value="">' + output.defaultText + '</option>';
    var optionCount = output.data.length;
    var idColIndex = code.getHeaderIndex( output.headers, 'id' );
    var firstColIndex = code.getHeaderIndex( output.headers, 'firstname' );
    var lastColIndex = code.getHeaderIndex( output.headers, 'lastname' );
    var suffixColIndex = code.getHeaderIndex( output.headers, 'suffix' );

    for ( var i = 0; i < optionCount; i++ ) {
        html += '<option value="' + output.data[ i ][ idColIndex ] + '">';
        html += code.titleCase(
            output.data[ i ][ firstColIndex ] + ' ' +
            output.data[ i ][ lastColIndex ] + ' ' +
            output.data[ i ][ suffixColIndex ]
        );
        html += '</option>';
    }

    donorMenu.innerHTML = html;

    // reset the donors select menu
    donorMenu.value = '';

    // stop the spinner
    code.hideSpinner();
};

code.getPaymentMethodsHtml = function( output ) {

    // save the HTML for the payment methods as a variable to be reused
    code.paymentMethodsHtml = output;

    // stop the spinner
    code.hideSpinner();
};

code.getDonationTypesHtml = function( output ) {

    // save the HTML for the payment methods as a variable to be reused
    code.donationTypesHtml = output;

    // stop the spinner
    code.hideSpinner();
};

/**
 * Clears the table so that new donations can be loaded.
 * @return {[type]} [description]
 */
code.clearTable = function() {

    // 1. Get the table rows
    var table = document.getElementById( 'edit-donations-table' );
    var oldBody = table.getElementsByTagName( 'tbody' )[ 0 ];
    var newBody = document.createElement( 'tbody' );

    // 2. Replace the old <tbody> with this newly created one
    oldBody.parentNode.replaceChild( newBody, oldBody );
};


/**
 * Will fill the table with rows containing donation data.
 * @param  {[type]} output [description]
 * @return {[type]}        [description]
 */
code.fillTable = function( output ) {
    var printout = JSON.stringify( output );
    code.log( 'fillTable(); ' + printout, false );

    // 1. Get the table rows
    var table = document.getElementById( 'edit-donations-table' );
    var oldBody = table.getElementsByTagName( 'tbody' )[ 0 ];
    var newBody = document.createElement( 'tbody' );

    var html = '';

    var count = output.data && code.isEmptyObject( output.data ) === false ?
    output.data.length : 0;

    var donationId = code.getHeaderIndex( output.headers, 'id' );
    var givenAtId = code.getHeaderIndex( output.headers, 'given_at' );
    var amountId = code.getHeaderIndex( output.headers, 'amount' );
    var donationTypeId = code.getHeaderIndex( output.headers, 'donationtype_id' );
    var paymentMethodId = code.getHeaderIndex( output.headers, 'paymentmethod_id' );
    var donorIdId = code.getHeaderIndex( output.headers, 'donor_id' );

    // 1. Loop through the rows and create the table rows
    // TODO: Do not use "magic" numbers for the indexes below
    for ( var i = 0; i < count; i++ ) {
        var rowId = output.data[ i ][ donationId ];
        var givenAt = output.data[ i ][ givenAtId ];
        var donorId = output.data[ i ][ donorIdId ];

        // dollar amounts are given with the dollar sign
        // this removes the dollar sign so they can be processed properly
        var amount = ( output.data[ i ][ amountId ] + '' ).replace( /\$/gi, '' );
        var donationType = code.getDonationPartMenu(
            output.paymentMethodHeaders,
            'donationtype_id',
            code.donationTypesHtml,
            output.data[ i ][ donationTypeId ],
            rowId
        );
        var paymentMethod = code.getDonationPartMenu(
            output.paymentMethodHeaders,
            'paymentmethod_id',
            code.paymentMethodsHtml,
            output.data[ i ][ paymentMethodId ],
            rowId
        );
        html += '<tr data-row-id="' + rowId + '">' + '\r\n';

        // copy the date input from donations.html so that it works the same
        html += '<td>';
        html += '<input type="date" name="given_at" step="1" ' +
        'min="1970-01-01" pattern="[0-9]{4}-[0-9]{2}-[0-9]{2}" ' +
        'placeholder="yyyy-mm-dd" ' +
        'autocomplete="off" data-row-id="' + rowId + '" name="given_at" ' +
        'value="' + givenAt + '" class="given_at" />';
        html += '</td>';

        // amount
        html += '<td>';
        html += '<input type="number" ' +
        ' name="amount" ' +
        'autocomplete="off" placeholder="0000.00" step="0.01" min="0.00" ' +
        'data-row-id="' + rowId + '" value="' + amount + '" class="amount" />';
        html += '</td>';

        html += paymentMethod;
        html += donationType;

        // save button
        html += code.getDonationSaveBtn( rowId, donorId );

        // delete button
        html += code.getDonationDeleteBtn( rowId, donorId );

        // closes the row
        html += '</tr>' + '\r\n';
    }

    newBody.innerHTML = html;

    // 2. Replace the old <tbody> with this newly created one
    oldBody.parentNode.replaceChild( newBody, oldBody );

    // 3. Reset the loading button text
    code.loadBtn.textContent = 'Load';
    code.hideSpinner();
};

code.getDonationSaveBtn = function( rowId, donorId ) {

    var html = '<td>';
    html += '<button type="button" class="btn action donation-save" ';
    html += 'data-donor-id="' + donorId + '" ';
    html += 'data-original-text="Save" ';
    html += 'data-loading-text="Saving..." ';
    html += 'data-row-id="' + rowId + '">';
    html += 'Save';
    html += '</button>';
    html += '</td>';
    return html;
};

code.getDonationDeleteBtn = function( rowId, donorId ) {

    var html = '<td>';
    html += '<button type="button" class="btn create donation-delete" ';
    html += 'data-donor-id="' + donorId + '" ';
    html += 'data-original-text="Delete" ';
    html += 'data-loading-text="Deleting..." ';
    html += 'data-row-id="' + rowId + '">';
    html += 'Delete';
    html += '</button>';
    html += '</td>';
    return html;
};

/**
 * Creates the HTML for the payment methods and donation types for
 * each transaction row.
 * @param  {[type]} headers  [description]
 * @param  {[type]} name     [description]
 * @param  {[type]} options  [description]
 * @param  {[type]} selected [description]
 * @return {string}          [description]
 */
code.getDonationPartMenu = function( headers, name, options, selected, rowId ) {

  var itemId = code.getHeaderIndex( headers, 'id' );
  var nameId = code.getHeaderIndex( headers, 'name' );
  var count = Array.isArray( options ) === true ? options.length : 0;

  var output = '<td>';
  output += '<select ' +
  'name="' + name + '" autocomplete="off" ';
  output += 'data-row-id="' + rowId + '">';
  output += '>';

  for ( var i = 0; i < count; i++ ) {
      output += '<option value="' + options[ i ][ itemId ] + '" ';
      if ( selected === options[ i ][ itemId ] ) {
          output += 'selected="selected"';
      }
      output += '>';
      output += options[ i ][ nameId ];
      output += '</option>';
  }

  output += '</select>';
  output += '</td>';
  return output;
};

if ( code.isNullOrEmpty( code.donationsTable ) === false ) {
    code.donationsTable.addEventListener( 'click', function( event ) {
        var element = event.target;

        // handle clicking the delete button
        if ( element.tagName.toLowerCase() === 'button' &&
        code.hasClass( element, 'donation-delete' ) === true &&
        element.hasAttribute( 'data-row-id' ) === true &&
        window.confirm( 'Are you sure you want to delete this donation? ' +
        ' This action cannot be undone' ) === true ) {
            code.log( 'Attempting to delete donation "' +
            element.getAttribute( 'data-row-id' ) + '"...' );

            // delete the donation
            code.deleteDonation( element );
        }

        // handle clicking the save button
        if ( element.tagName.toLowerCase() === 'button' &&
        code.hasClass( element, 'donation-save' ) === true &&
        element.hasAttribute( 'data-row-id' ) === true ) {
            code.log( 'Attempting to save changes to donation "' +
            element.getAttribute( 'data-row-id' ) + '"...' );

            // save the changes to the donation
            code.saveDonation( element );
        }

    } );
}

/**
 * Deletes a donation.
 * @param  {[type]} element [description]
 * @return {[type]}         [description]
 */
code.deleteDonation = function( element ) {

    // 1. Get the ID of the current donation
    var donationId = element.getAttribute( 'data-row-id' );

    // 2. Delete the donation
    google.script.run.withSuccessHandler( code.hideDeletedDonation )
    .withFailureHandler( code.donationSaveFailed )
    .withUserObject( donationId )
    .deleteData( 'donations', donationId );

    // 3. Show the loading spinner
    code.showSpinner();
};

/**
 * Deletes the row from the UI and hides the spinner upon successfully
 * deleting a donation.
 * @param  {boolean} result     [description]
 * @param  {string}  donationId [description]
 * @return {boolean}
 */
code.hideDeletedDonation = function( result, donationId ) {

    code.log( 'donationId: "' + donationId + '"' );

    if ( result !== true ) {
        code.log( 'The donation was NOT deleted successfully.', true );
        code.hideSpinner();
        return false;
    }

    // 1. Find the row in the table that has the specified donation ID
    var row = document.querySelector(
      '#edit-donations-table tr[data-row-id="' + donationId + '"]'
    );

    if ( row !== null ) {
        row.remove();
    }

    // 2. Hide the loading spinner
    code.hideSpinner();
    return true;
};

/**
 * Saves any changes to the current donation
 * @param  {HTMLDomElement} element [description]
 * @return {boolean}         [description]
 */
code.saveDonation = function( element ) {

    // 1. Based on the donation id, get all of the required fields for
    // validating a donation
    var donationId = element.getAttribute( 'data-row-id' );
    var donorId = element.getAttribute( 'data-donor-id' );
    var amount = code.getDonationCellValue( 'amount', donationId );
    var paymentMethodId = code.getDonationCellValue(
        'paymentmethod_id',
        donationId
    );
    var donationTypeId = code.getDonationCellValue(
        'donationtype_id',
        donationId
    );
    var givenAt = code.getDonationCellValue( 'given_at', donationId );

    var error = code.validateDonationInput(
        donationId,
        donorId,
        amount,
        paymentMethodId,
        donationTypeId,
        givenAt
    );

    // 2. If an error has occurred, show an alert box and stop here
    if ( code.isNullOrEmptySpace( error ) === false ) {
        alert( error );
        return false;
    }

    // 3. If there is no error, then attempt to save the changes
    var data = {};
    data.id = donationId;
    data.donor_id = donorId;
    data.donationtype_id = donationTypeId;
    data.given_at = givenAt;
    data.amount = amount;

    // Saves the new donation data
    google.script.run.withSuccessHandler( code.hideSpinner )
    .withFailureHandler( code.donationSaveFailed )
    .saveData( 'donations', donationId, data );

    // 4. Show the loading spinner
    code.showSpinner();
};

/**
 * Handles what happens when a delete or save fails.
 * @param  {Error} obj [description]
 * @return {[type]}     [description]
 * @see https://developers.google.com/apps-script/guides/html/reference/run#withFailureHandler(Function)
 * @see https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Error
 */
code.donationSaveFailed = function( obj ) {
    code.log( obj.name + ': ' + obj.message, true );
    code.hideSpinner();
    alert( 'Your donation was not saved successfully. Please try again.' );
};

/**
 * Used to get the value from the table for a specific donation.
 * @param  {string} name  [description]
 * @param  {[type]} rowId [description]
 * @return {string}       [description]
 */
code.getDonationCellValue = function( name, rowId ) {
    if ( code.isNullOrEmptySpace( name ) === true ||
    code.isNullOrEmptySpace( rowId ) === true ) {
        return '';
    }

    var element = document.querySelector(
        '[name="' + name + '"][data-row-id="' + rowId + '"]'
    );

    return element !== null && element.value ? element.value : '';
};


if ( code.isNullOrEmpty( code.loadBtn ) === false ) {
    code.loadBtn.onclick = function() {

        // 1. Clear the table
        code.clearTable();

        // 2. Get the ID of the current user. If none, then stop here.
        var userId = code.donors.value;
        if ( code.isNullOrEmptySpace( userId ) === true || userId === '-1' ||
        userId === -1 ) {

            // stop the spinner and return
            code.log( 'no user specified, stopping', false );
            code.loadBtn.textContent = 'Load';
            code.hideSpinner();
            return;
        }

        // 3. Attempt to load the data for this user.
        // asynchronously get the user donations
        google.script.run.withSuccessHandler( code.fillTable )
        .withFailureHandler( code.fillTable )
        .getUserDonations(
            userId,
            code.getValue( 'start_at' ),
            code.getValue( 'end_at' )
        );

        code.loadBtn.textContent = 'Loading...';

        code.showSpinner();
    };
}

/**
 * Sets the default date range for loading donations for a user.
 * @return {void}
 */
code.setDefaultDateRange = function() {

    // 1. Get the date for today and 1 month ago
    var now = new Date();
    var monthAgo = new Date();
    monthAgo.setMonth( now.getMonth() - 1 );

    // 2. Set the values of the textboxes to the dates
    code.startAt.value = monthAgo.toISODateString();
    code.endAt.value = now.toISODateString();
};


/**
* Code run to load the donors
*/
if ( google && google.script && google.script.run ) {

    // google.script.run.withSuccessHandler( code.addDonorsHtml )
    // .getMenuData( 'donors', 'donor_id', 'Select a donor' );
    code.getMenu( 'donors', 'donor_id', 'Select a donor...' );

    google.script.run.withSuccessHandler( code.getPaymentMethodsHtml )
    .getDataValues( 'payment-methods' );

    google.script.run.withSuccessHandler( code.getDonationTypesHtml )
    .getDataValues( 'donation-types' );
}

// load the default dates
code.setDefaultDateRange();


// confirms whether the user is sure if they want to complete the given action
} )( window.code = window.code || {},
  window.jQuery,
  window,
  window.document,
  window.google = window.google || {},
  window.moment = window.moment || {}
);

// Down here is the code the defines the parameters used at the top of this
// self-executing function. undefined is not defined so it is undefined. LOL
