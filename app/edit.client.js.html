/* eslint-env browser, node */
/* global moment */

;( function( code, $, window, document, google, moment, undefined ) {

// This allows for javascript that should work pretty consistently across browsers and platforms.
'use strict';

// log that the file has been reached
code.log( 'edit.client.js loaded.' );

code.donors = document.getElementById( 'donor_id' );
code.endAt = document.getElementById( 'end_at' );
code.startAt = document.getElementById( 'start_at' );
code.loadBtn = document.getElementById( 'edit-donations-load-btn' );

code.clearAllFields = function() {

};

/**
 * Adds the options to the "donors" select element.
 * @param  {[type]} output [description]
 * @return {[type]}        [description]
 */
code.addDonorsHtml = function( output ) {

    code.log( 'addDonorsHtml(); output: ' + JSON.stringify( output ) );

    if ( code.isNullOrEmpty( output ) === true ) {

        // stop the spinner
        code.hideSpinner();

        return false;
    }

    // add an option for manually entering the name of a new donor on the fly
    // output = '<option value="-1">Add new donor</option>' + output;
    var donorMenu = document.getElementById( output.selectId );

    // set the HTML of the select element
    var html = '<option value="">' + output.defaultText + '</option>';
    var optionCount = output.data.length;
    var idColIndex = code.getHeaderIndex( output.headers, 'id' );
    var firstColIndex = code.getHeaderIndex( output.headers, 'firstname' );
    var lastColIndex = code.getHeaderIndex( output.headers, 'lastname' );
    var suffixColIndex = code.getHeaderIndex( output.headers, 'suffix' );

    for ( var i = 0; i < optionCount; i++ ) {
        html += '<option value="' + output.data[ i ][ idColIndex ] + '">';
        html += code.titleCase(
            output.data[ i ][ firstColIndex ] + ' ' +
            output.data[ i ][ lastColIndex ] + ' ' +
            output.data[ i ][ suffixColIndex ]
        );
        html += '</option>';
    }

    donorMenu.innerHTML = html;

    // reset the donors select menu
    donorMenu.value = '';

    // stop the spinner
    code.hideSpinner();
};

code.getPaymentMethodsHtml = function( output ) {

    // save the HTML for the payment methods as a variable to be reused
    code.paymentMethodsHtml = output;

    // stop the spinner
    code.hideSpinner();
};

code.getDonationTypesHtml = function( output ) {

    // save the HTML for the payment methods as a variable to be reused
    code.donationTypesHtml = output;

    // stop the spinner
    code.hideSpinner();
};

/**
 * Clears the table so that new donations can be loaded.
 * @return {[type]} [description]
 */
code.clearTable = function() {

    // 1. Get the table rows
    var table = document.getElementById( 'edit-donations-table' );
    var oldBody = table.getElementsByTagName( 'tbody' )[ 0 ];
    var newBody = document.createElement( 'tbody' );

    // 2. Replace the old <tbody> with this newly created one
    oldBody.parentNode.replaceChild( newBody, oldBody );
};

/**
 * Will fill the table with rows containing donation data.
 * @param  {[type]} output [description]
 * @return {[type]}        [description]
 */
code.fillTable = function( data ) {
    var printout = JSON.stringify( data );
    code.log( 'fillTable(); ' + printout, false );

    // 1. Get the table rows
    var table = document.getElementById( 'edit-donations-table' );
    var oldBody = table.getElementsByTagName( 'tbody' )[ 0 ];
    var newBody = document.createElement( 'tbody' );

    var output = '';
    var count = code.isEmptyObject( data ) === false ? data.length : 0;

    // 1. Loop through the rows and create the table rows
    // TODO: Do not use "magic" numbers for the indexes below
    for ( var i = 0; i < count; i++ ) {
        var rowId = data[ i ][ 0 ];
        var givenAt = data[ i ][ 3 ];
        var amount = data[ i ][ 4 ]; // check this obviously
        var donationType = createTypeMenu( data[ i ][ 2 ] );
        var paymentMethod = createMethodMenu( data[ i ][ 5 ] );
        output += '<tr>';

        // copy the date input from donations.html so that it works the same
        output += '<td>';
        output += '<input type="date" id="given_at" name="given_at" step="1" ' +
        'min="1970-01-01" pattern="[0-9]{4}-[0-9]{2}-[0-9]{2}" ' +
        'placeholder="yyyy-mm-dd" class="form-control google-full-width" ' +
        'autocomplete="off" data-row-id="' + rowId + '" name="given_at" ' +
        'value="' + givenAt + '" class="given_at" />';
        output += '</td>';

        // amount
        output += '<td>';
        output += '<input type="number" ' +
        'class="form-control google-full-width" name="amount" ' +
        'autocomplete="off" placeholder="0000.00" step="0.01" min="0.00" ' +
        'data-row-id="' + rowId + '" value="' + amount + '" class="amount"  />';
        output += '</td>';

        output += paymentMethod;
        output += donationType;
        output += '</tr>';
    }

    newBody.innerHTML = output;

    // 2. Replace the old <tbody> with this newly created one
    oldBody.parentNode.replaceChild( newBody, oldBody );


};

/**
 * Creates the payment method menu for each donation.
 * @param  {[type]} selected [description]
 * @return {string}          [description]
 */
code.createMethodMenu = function( selected ) {
    var output = '<td>';
    output += '<select class="form-control google-full-width" ' +
    'name="paymentmethod_id" autocomplete="off">';

    output += code.paymentMethodsHtml;

    // TODO: a for loop would be used here so that we can set the selected
    // payment method in the menu

    output += '</select>';
    output += '</td>';
    return output;
};

/**
 * [description]
 * @param  {[type]} selected [description]
 * @return {string}          [description]
 */
code.createTypeMenu = function( selected ) {
    var output = '<td>';
    output += '<select class="form-control google-full-width" ' +
    'name="donationtype_id" autocomplete="off">';

    output += code.paymentMethodsHtml;

    // TODO: a for loop would be used here so that we can set the selected
    // payment method in the menu

    output += '</select>';
    output += '</td>';
    return output;
};

if ( code.isNullOrEmpty( code.loadBtn ) === false ) {
    code.loadBtn.onclick = function() {

        // 1. Clear the table
        code.clearTable();

        // 2. Get the ID of the current user. If none, then stop here.
        var userId = code.donors.value;
        if ( code.isNullOrEmptySpace( userId ) === true || userId === '-1' ||
        userId === -1 ) {

            // stop the spinner and return
            code.log( 'no user specified, stopping', false );
            code.hideSpinner();
            return;
        }

        // 3. Attempt to load the data for this user.
        // asynchronously get the user donations
        google.script.run.withSuccessHandler( code.fillTable )
        .withFailureHandler( code.fillTable )
        .getDonationFilterCriteria(
            userId,
            code.getValue( 'start_at' ),
            code.getValue( 'end_at' )
        );
    };
}

code.setDefaultDateRange = function() {

    // 1. Get the date for today and 1 month ago
    var now = new Date();
    var monthAgo = new Date();
    monthAgo.setMonth( now.getMonth() - 1 );

    // 2. Set the values of the textboxes to the dates
    code.startAt.value = monthAgo.toISODateString();
    code.endAt.value = now.toISODateString();
};


/**
* Code run to load the donors
*/
if ( google && google.script && google.script.run ) {

    google.script.run.withSuccessHandler( code.addDonorsHtml )
    .getMenuData( 'donors', 'donor_id', 'Select a donor' );

    // google.script.run.withSuccessHandler( code.getPaymentMethodsHtml )
    // .getDataValues( 'payment-methods' );
    //
    // google.script.run.withSuccessHandler( code.addDonationTypesHtml )
    // .getDataValues( 'donation-types' );
}

// load the default dates
code.setDefaultDateRange();


// confirms whether the user is sure if they want to complete the given action
} )( window.code = window.code || {},
  window.jQuery,
  window,
  window.document,
  window.google = window.google || {},
  window.moment = window.moment || {}
);

// Down here is the code the defines the parameters used at the top of this
// self-executing function. undefined is not defined so it is undefined. LOL
